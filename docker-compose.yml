services:
  postgres:
    image: postgres:latest
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app_db
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:latest
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  app:
    build: .
    tty: true
    ports:
      - "8000:8000"          # expose Rocket to host
    volumes:
      - ./:/app/             # hot-reload / dev editing
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/app_db
      ROCKET_DATABASES: |
        {
          postgres={url=postgres://postgres:postgres@postgres:5432/app_db},
          redis={url=redis://redis:6379}
        }
      ROCKET_PROFILE: default
      CR8S_APP_MODE: # ðŸ‘ˆ expecting; --release or ""
      # (optional) e-mail creds â€” consider .env or secrets instead
      SMTP_HOST: smtp.gmail.com
      SMTP_USERNAME: you@example.com
      SMTP_PASSWORD: okks qghu trly qwot
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: [ "sh", "-c", "cargo run $${CR8S_APP_MODE} --bin server" ]
